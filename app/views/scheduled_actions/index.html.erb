<section class="section">
<div class="row">
  <div class="col-md-12">
    <div class="calendar-header">
      <div class="calendar-header__left">
        <h1>My Task Calendar</h1>
        <% if policy(ScheduledAction).new? %>
          <%= link_to new_scheduled_action_path, class: "btn btn--primary schedule-new-task" do %>
            <span class="glyphicon glyphicon-plus"></span>
            Schedule New Task
          <% end %>
        <% end %>
      </div>
      
      <div class="calendar-header__right">
        <div class="task-type-toggle">
          <%= link_to scheduled_actions_path(team: true), 
              class: "task-type-toggle__option #{!@all_tasks ? 'active' : ''}", 
              data: { toggle: "tooltip", placement: "bottom" }, 
              title: "View scheduled tours" do %>
            <span class="glyphicon glyphicon-home"></span>
            Tours
          <% end %>
          
          <%= link_to scheduled_actions_path(all: true), 
              class: "task-type-toggle__option #{@all_tasks && !@team_tasks ? 'active' : ''}", 
              data: { toggle: "tooltip", placement: "bottom" }, 
              title: "View your personal tasks" do %>
            <span class="glyphicon glyphicon-user"></span>
            My Tasks
          <% end %>
          
          <%= link_to scheduled_actions_path(all: true, team: true), 
              class: "task-type-toggle__option #{@all_tasks && @team_tasks ? 'active' : ''}", 
              data: { toggle: "tooltip", placement: "bottom" }, 
              title: "View all team tasks" do %>
            <span class="glyphicon glyphicon-th-list"></span>
            Team Tasks
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Calendar component -->
<% cache([@current_user, "calendar_table", @start_date, @current_user.task_calendar_expiration]) do %>
<div class="row">
  <div class="col-md-12">
    <% events = @scheduled_actions.sorted_by_due_asc %>
    <%= month_calendar events: events do |date, scheduled_actions| %>
      <% # Sorts events by Object.start_time %>
      <div class="scheduled_action_calendar_day">
        <%= date.day %><br/>
        <% grouped_tasks = scheduled_actions.to_a.group_by{|t| t.lead_action&.name || 'Misc'} %>
        <% grouped_tasks.keys.sort.each do |lead_action_name| %>
          <% count = grouped_tasks[lead_action_name].size %>
          <% selector_id = "#{date.month}_#{date.day}_#{lead_action_name.parameterize.underscore}" %>
          <%#= render partial: 'calendar_line_item', collection: grouped_tasks[lead_action_name], as: :scheduled_action %>
          <% if count > 1 %>
            <span class="scheduled_action_calendar_entry">
              <a role="button" aria-expanded="false" aria-controls="<%= selector_id %>" data-toggle="collapse" href="#<%= selector_id %>"> 
                <%= lead_action_name %> (<%= count %>)
              </a>
            </span><br/>
            <div class="well collapse" id="<%= selector_id %>">
              <%= render partial: 'calendar_line_item', collection: grouped_tasks[lead_action_name], as: :scheduled_action %>
            </div>
          <% else %>
            <%= render partial: 'calendar_line_item', collection: grouped_tasks[lead_action_name], as: :scheduled_action %>
          <% end %>
        <% end # each lead_action_name %>
      </div>
    <% end # month_calendar %>
  </div>
</div>
<% end %>
</section>
<!-- Due and Upcoming tasks -->
<section class="section">
<div class="row">
  <div class="col-md-12">
    <div class="row">
      <div class="col-md-6">
        <h3>Due or Upcoming</h3>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <%= render partial: "scheduled_actions", locals: { scheduled_actions: @scheduled_actions.upcoming_or_incomplete.sorted_by_due_desc.limit(50) } %>
      </div>
    </div>
  </div>
</div>
</section>

<!-- Previous tasks -->
<section class="section">
<% cache([@current_user, "calendar_previous_tasks", @start_date, @current_user.task_calendar_expiration]) do %>
<div class="row">
  <div class="col-md-12">
    <div class="row">
      <div class="col-md-6">
        <h3>Previous</h3>
      </div>
      <% unless @limit_set %>
        <div class="col-md-6 text-right">
          <%= link_to "View All", scheduled_actions_path(limit: 200, start_date: @start_date, all: @all_tasks, team: @team_tasks), class: "btn btn--small btn--info" %>
        </div>
      <% end %>
    </div>
    <div class="row">
      <div class="col-md-12">
        <%= render partial: "scheduled_actions", locals: { scheduled_actions: @scheduled_actions.previous_month.sorted_by_due_desc.limit(20) } %>
      </div>
    </div>
  </div>
</div>
<% end %>
</section>
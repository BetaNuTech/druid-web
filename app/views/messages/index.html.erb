<!-- Messages Page -->
<div class="messages-page">
  <!-- Hero Header -->
  <div class="messages-hero">
    <div class="container">
      <h1 class="messages-hero__title">
        <%= glyph(:envelope) %>
        Messages
        <% if @messageable.present? %>
          <span class="messages-hero__subtitle">for <%= @messageable.name %></span>
        <% end %>
      </h1>
      
      <div class="messages-hero__stats">
        <div class="messages-hero__stat">
          <span class="messages-hero__stat-value"><%= @messages.total_count %></span>
          <span class="messages-hero__stat-label">Total Messages</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Section -->
  <section class="section">
    <div class="messages-filter">
        <div class="section-header section-header--minimal">
          <div class="section-header__content">
            <div class="section-header__icon">
              <%= glyph(:filter) %>
            </div>
            <h3 class="section-header__title">Filter Messages</h3>
          </div>
        </div>
        
        <%= form_for(@search, url: messages_path, method: :get, id: 'messages-filter-form') do |form| %>
          <div class="messages-filter__content">
          <div class="messages-filter__group">
            <h4 class="messages-filter__group-title">Status</h4>
            <div class="messages-filter__options">
              <label class="messages-filter__option">
                <%= form.check_box :unread, class: 'messages-filter__checkbox' %>
                <span class="messages-filter__switch"></span>
                <span class="messages-filter__label">
                  <%= glyph(:envelope) %> Unread
                </span>
              </label>
              
              <label class="messages-filter__option">
                <%= form.check_box :draft, class: 'messages-filter__checkbox' %>
                <span class="messages-filter__switch"></span>
                <span class="messages-filter__label">
                  <%= glyph(:file) %> Drafts
                </span>
              </label>
              
              <label class="messages-filter__option">
                <%= form.check_box :failed, class: 'messages-filter__checkbox' %>
                <span class="messages-filter__switch"></span>
                <span class="messages-filter__label">
                  <%= glyph(:warning_sign) %> Failed
                </span>
              </label>
            </div>
          </div>
          
          <div class="messages-filter__group">
            <h4 class="messages-filter__group-title">Direction</h4>
            <div class="messages-filter__options">
              <label class="messages-filter__option">
                <%= form.check_box :incoming, class: 'messages-filter__checkbox' %>
                <span class="messages-filter__switch"></span>
                <span class="messages-filter__label">
                  <%= glyph(:arrow_left) %> Incoming
                </span>
              </label>
              
              <label class="messages-filter__option">
                <%= form.check_box :outgoing, class: 'messages-filter__checkbox' %>
                <span class="messages-filter__switch"></span>
                <span class="messages-filter__label">
                  <%= glyph(:arrow_right) %> Outgoing
                </span>
              </label>
            </div>
          </div>
        </div>
        
          <div class="messages-filter__actions">
            <%= form.submit 'Apply Filters', class: "btn btn--primary" %>
            <%= link_to 'Clear All', messages_path, class: "btn btn--secondary" %>
          </div>
        <% end %>
    </div>
  </section>

  <!-- Messages List -->
  <section class="section section--no-padding">
    <div class="messages-list">
        <% if @messages.any? %>
          <% @messages.each do |message| %>
            <% next unless policy(message).show? %>
            <%= render partial: 'shared/message_card', locals: { message: message, messageable: message.messageable, show_lead_link: true } %>
          <% end %>
        <% else %>
          <div class="empty-state">
            <div class="empty-state__icon">
              <%= glyph(:envelope) %>
            </div>
            <h3 class="empty-state__title">No messages found</h3>
            <p class="empty-state__text">Try adjusting your filters or compose a new message to get started.</p>
          </div>
        <% end %>
    </div>
    
    <!-- Pagination -->
    <% if @messages.any? %>
      <div class="pagination-wrapper">
        <%= paginate @messages, params: @search.pagination_params %>
      </div>
    <% end %>
  </section>

  <% if current_user.setting_enabled?(:view_all_messages) %>
    <section class="section">
        <div class="alert alert--info">
          <h4 class="alert__title">
            <%= glyph(:info_sign) %> Too many messages?
          </h4>
          <div class="alert__content">
            <p>To view only messages to and from YOUR leads:</p>
            <ol>
              <li>Go to your <%= link_to('Profile', edit_user_path(current_user)) %> page</li>
              <li>Find the "Blue Sky Application Settings" section</li>
              <li>Uncheck "View all messages" option</li>
              <li>Click "Save"</li>
            </ol>
          </div>
        </div>
    </section>
  <% end %>

  <% if @messageable.present? %>
    <section class="section section--minimal">
      <%= link_to url_for(@messageable), class: "btn btn--secondary" do %>
        <%= glyph(:arrow_left) %> Back to <%= @messageable.class.name.humanize %>
      <% end %>
    </section>
  <% end %>
</div>
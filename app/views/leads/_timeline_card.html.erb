<%
  # Map lead actions and activity types to timeline CSS classes
  timeline_class = if activity.lead_action.present?
    case activity.lead_action.name.downcase
    when /state.*(change|transition)/i
      'timeline-item--state-change'
    when /email/i
      'timeline-item--email-sent'
    when /sms|text/i
      'timeline-item--sms-sent'
    when /message/i
      'timeline-item--message-sent'
    when /task/i
      activity.respond_to?(:completed?) && activity.completed? ? 'timeline-item--task-completed' : 'timeline-item--lead-task'
    when /opt.?in/i
      'timeline-item--lead-email-sms-opt-in'
    when /comment|note/i
      'timeline-item--comment'
    else
      "timeline-item--#{activity.lead_action.name.parameterize}"
    end
  elsif activity.respond_to?(:messageable) && activity.messageable.present? && activity.messageable_type == 'Message'
    activity.messageable.category == 'sms' ? 'timeline-item--sms-sent' : 'timeline-item--email-sent'
  else
    'timeline-item--note'
  end
%>
<div class="timeline-item <%= timeline_class %>" id="timeline_<%= activity.id %>">
  <div class="timeline-card">
    <div class="timeline-card__icon">
      <% if activity.lead_action.present? %>
        <%= glyph(activity.lead_action.glyph || :record) %>
      <% elsif activity.respond_to?(:messageable) && activity.messageable.present? %>
        <% if activity.messageable_type == 'Message' %>
          <%= glyph(activity.messageable.category == 'sms' ? :phone : :envelope) %>
        <% else %>
          <%= glyph(:comment) %>
        <% end %>
      <% else %>
        <%= glyph(:comment) %>
      <% end %>
    </div>
    
    <div class="timeline-card__content">
      <div class="timeline-card__header">
        <h4 class="timeline-card__title">
          <% if activity.lead_action.present? %>
            <%= action_and_reason(activity) %>
          <% elsif activity.respond_to?(:messageable) && activity.messageable.present? %>
            <%= activity.messageable_type == 'Message' ? "#{activity.messageable.category.upcase} Message" : activity.messageable_type %>
          <% else %>
            Comment
          <% end %>
        </h4>
        <span class="timeline-card__timestamp">
          <%= short_datetime(activity.created_at) %>
        </span>
      </div>
      
      <% if activity.user.present? %>
        <div class="timeline-card__meta">
          <span class="timeline-card__user">
            <%= glyph(:user) %> <%= activity.user.name %>
          </span>
        </div>
      <% end %>
      
      <% if note_content(activity).present? %>
        <div class="timeline-card__body">
          <%= simple_format(note_content(activity)) %>
        </div>
      <% end %>
      
      <% if activity.respond_to?(:state_event) && activity.state_event.present? %>
        <div class="timeline-card__state-change">
          <span class="timeline-card__state-badge timeline-card__state-badge--<%= activity.state_event %>">
            <%= activity.state_event.humanize %>
          </span>
          <% if activity.respond_to?(:to_state) && activity.to_state.present? %>
            <span class="timeline-card__state-arrow">â†’</span>
            <span class="timeline-card__state-badge timeline-card__state-badge--<%= activity.to_state %>">
              <%= activity.to_state.humanize %>
            </span>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>